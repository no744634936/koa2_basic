1，router 查看路由，输入那个网址就对应controller里面的那个方法。
2，controller里面的方法会导向某个view。并给这个view传一些数据。
3，controller 里面的方法又会去model里面获取数据
   (在这个项目里面model 是service/home.js文件)

4，定义的一些中间件就放在middleware/index.js文件里面。
   中间件主要是一些导入的包。和自己写的一些包。

5，app.js 文件就主要管理middleware跟router就可以了。




---------------------------------------------------------------------
json文件的显示

我们只需要设置把数据挂载在响应体 body 上，
同时告诉客户端『返回的是 JSON 数据』，客户端就会按照 JSON 来解析了。代码如下：

ctx.set("Content-Type", "application/json")
ctx.body = JSON.stringify(json)

提取中间件

我们把上面的代码提取成一个中间件，这样更方便代码的维护性和扩展性
增加文件 /middleware/mi-send/index.js：

module.exports = () => {
  function render(json) {
      this.set("Content-Type", "application/json")
      this.body = JSON.stringify(json)
  }
  return async (ctx, next) => {
      ctx.send = render.bind(ctx)
      await next()
  }
}
注意： 目录不存在，需要自己创建。


代码中，我们把 JSON 数据的处理方法挂载在 ctx 对象中，并起名为 send。当我们需要返回 JSON 数据给客户端时候，只需要调用此方法，并把 JSON 对象作为参数传入到方法中就行了，用法如下：

ctx.send({
  status: 'success',
  data: 'hello ikcmap'
})

应用中间件
代码的实现过程和调用方法我们已经知道了，现在我们需要把这个中间件应用在项目中。


增加文件 middleware/index.js，用来集中调用所有的中间件：
const miSend = require('./mi-send')
module.exports = (app) => {
  app.use(miSend())
}

修改 app.js，增加中间件的引用
const Koa = require('koa')
const path = require('path')
const bodyParser = require('koa-bodyparser')
const nunjucks = require('koa-nunjucks-2')
const staticFiles = require('koa-static')

const app = new Koa()
const router = require('./router')

const middleware = require('./middleware')

middleware(app)

app.use(staticFiles(path.resolve(__dirname, "./public")))

app.use(nunjucks({
  ext: 'html',
  path: path.join(__dirname, 'views'),
  nunjucksConfig: {
    trimBlocks: true
  }
}));

app.use(bodyParser())
router(app)
app.listen(3000, () => {
  console.log('server is running at http://localhost:3000')
})

中间件迁移
随着项目的步步完善，将会产生有更多的中间件。我们把 app.js 中的中间件代码迁移到 middleware/index.js 中，方便后期维护扩展


修改 app.js
const Koa = require('koa')
const app = new Koa()
const router = require('./router')

const middleware = require('./middleware')

middleware(app)
router(app)
app.listen(3000, () => {
  console.log('server is running at http://localhost:3000')
})

修改 middleware/index.js
const path = require('path')
const bodyParser = require('koa-bodyparser')
const nunjucks = require('koa-nunjucks-2')
const staticFiles = require('koa-static')

const miSend = require('./mi-send')
module.exports = (app) => {
  app.use(staticFiles(path.resolve(__dirname, "../public")))

  app.use(nunjucks({
    ext: 'html',
    path: path.join(__dirname, '../views'),
    nunjucksConfig: {
      trimBlocks: true
    }
  }));

  app.use(bodyParser())
  app.use(miSend())
}
